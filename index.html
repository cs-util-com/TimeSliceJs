<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ffmpeg.wasm Demo â€“ WebM to MP4 (ESM - Self-Hosted)</title>
  <!-- Scripts are loaded via local ES Module import -->
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 0 20px;
    }
    #status {
      margin: 20px 0;
      font-weight: bold;
    }
    #progressBar {
      width: 100%;
      max-width: 400px;
      margin: 10px 0;
    }
    #outputVideo {
      max-width: 100%;
      margin: 20px 0;
    }
    #errorLog {
      color: red;
      white-space: pre-wrap;
      background: #f8f8f8;
      padding: 10px;
      border-radius: 4px;
      display: block; /* Make sure errors are visible by default */
      border: 1px solid #ddd;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>WebM to MP4 Transcoder (ESM Load - Self-Hosted Assets)</h1>
  <div id="status">Initializing...</div>
  <progress id="progressBar" value="0" max="100"></progress>
  <video id="outputVideo" controls></video>
  <pre id="errorLog">Error Log:
---------------
</pre>

  <script type="module">
    const errorLogElement = document.getElementById('errorLog');
    const statusElement = document.getElementById('status');

    // Global error handler
    window.onerror = function(message, source, lineno, colno, error) {
      console.error("[Global Error Handler]", message, source, lineno, colno, error);
      errorLogElement.textContent += `\n[Global Error] ${message}\n  Source: ${source}\n  Line: ${lineno}, Col: ${colno}\n  Error Obj: ${error ? error.stack || error : 'N/A'}\n---------------\n`;
      if (!statusElement.textContent.startsWith("Error")) {
          statusElement.textContent = "A critical error occurred. Check error log.";
      }
      return false;
    };

    console.log('Module script executing...');
    statusElement.textContent = "Importing FFmpeg library (Local)...";

    // --- Define LOCAL paths ---
    // IMPORTANT: You must manually download ALL FOUR required files:
    // - ffmpeg.js          (from @ffmpeg/ffmpeg@0.12.10/dist/esm/)
    // - worker.js          (from @ffmpeg/ffmpeg@0.12.10/dist/esm/)
    // - ffmpeg-core.js     (from @ffmpeg/core@0.12.10/dist/esm/)
    // - ffmpeg-core.wasm   (from @ffmpeg/core@0.12.10/dist/esm/)
    // and place them in a local directory named 'ffmpeg-assets' relative to index.html
    const ffmpegPath = './ffmpeg-assets/ffmpeg.js';
    const corePath = './ffmpeg-assets/ffmpeg-core.js';

    try {
      // --- Import necessary items from the LOCAL main library build ---
      // Note: fetchFile might not be exported this way, may need adjustment
      const { FFmpeg } = await import(ffmpegPath); // Removed fetchFile import
      console.log('FFmpeg LOCAL module imported successfully.');
      statusElement.textContent = "FFmpeg library imported. Initializing...";

      // --- Instantiate the FFmpeg class ---
      const ffmpeg = new FFmpeg();
      console.log('FFmpeg instance created.');

      // --- Attach event handlers ---
      const progressBar = document.getElementById('progressBar');
      ffmpeg.on('progress', ({ progress, time }) => {
        // progress is 0-1, adjust for display
        const percent = Math.round(progress * 100);
        progressBar.value = percent;
        if (!statusElement.textContent.includes("complete") && !statusElement.textContent.includes("Error")) {
             // Check time exists and format it
             const timeStr = time ? ` (Time: ${Math.round(time / 1000)}s)` : '';
             statusElement.textContent = `Processing... ${percent}%${timeStr}`;
        }
      });
      ffmpeg.on('log', ({ type, message }) => {
        console.log(`[ffmpeg ${type}] ${message}`); // Log to console
      });

      // --- Load the core using LOCAL path ---
      statusElement.textContent = "Loading locally hosted ffmpeg.wasm core (may take time)...";
      console.log(`Loading FFmpeg core via ffmpeg.load() using local coreURL: ${corePath}...`);
      await ffmpeg.load({ coreURL: corePath });
      console.log('FFmpeg core loaded successfully via ffmpeg.load()');
      statusElement.textContent = "FFmpeg core loaded.";

      // --- Start FFmpeg processing ---
      const videoEl = document.getElementById('outputVideo');

      statusElement.textContent = "Fetching input video file...";
      console.log('Fetching input video...');
      // Use standard fetch for the video file.
      const videoResponse = await fetch(
        "https://raw.githubusercontent.com/ffmpegwasm/testdata/master/Big_Buck_Bunny_180_10s.webm"
      );
      if (!videoResponse.ok) {
        throw new Error(`Failed to fetch video: ${videoResponse.status} ${videoResponse.statusText}`);
      }
      const videoData = new Uint8Array(await videoResponse.arrayBuffer());
      console.log('Input video fetched successfully');

      await ffmpeg.writeFile('input.webm', videoData);
      console.log('Input video written to virtual filesystem');

      statusElement.textContent = "Transcoding to MP4 (this may take a moment)...";
      console.log('Starting transcoding...');
      await ffmpeg.exec(['-i', 'input.webm', 'output.mp4']);
      console.log('Transcoding completed');

      const outputData = await ffmpeg.readFile('output.mp4');
      console.log('Output file read');

      const blob = new Blob([outputData.buffer], { type: 'video/mp4' });
      const videoURL = URL.createObjectURL(blob);

      videoEl.src = videoURL;
      console.log('Video source set');

      statusElement.textContent = "Transcoding complete! Click play to view.";
      progressBar.value = 100;

      console.log('Processing finished.');

    } catch (err) {
      console.error('Error during module import or FFmpeg operation:', err);
      const errorMsg = `An error occurred: ${err.stack || err.toString()}`;
      errorLogElement.textContent += `\n[Error] ${errorMsg}\n---------------\n`;
      if (err.message && err.message.includes("import")) {
          statusElement.textContent = "Error importing local FFmpeg library. Check path/file existence.";
      } else if (statusElement.textContent.includes("Loading")) {
          statusElement.textContent = "Error loading FFmpeg core. Check local path and file existence.";
      } else {
          statusElement.textContent = "Error during processing. Check error log.";
      }
    }

  </script>
</body>
</html>