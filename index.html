<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>ffmpeg.wasm - Extract Frames</title>
    <!-- Include Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Optional: Add custom base styles or component styles if needed */
        /* For example, ensure pre tag wraps correctly */
        pre {
             white-space: pre-wrap; /* Ensures long error messages wrap */
             word-wrap: break-word; /* Breaks long words */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-6 max-w-2xl bg-white shadow-md rounded-lg mt-10">
        <h1 class="text-2xl font-bold mb-4 text-center text-blue-700">Extract 2 Frames from Video</h1>

        <!-- User Input -->
        <div class="mb-4">
            <label for="videoInput" class="block text-sm font-medium text-gray-700 mb-1">Select Video File:</label>
            <input type="file" id="videoInput" accept="video/*"
                   class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer focus:outline-none p-2" />
        </div>

        <!-- Action Button -->
        <button id="extractButton" disabled
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed">
            Load FFmpeg & Select File First
        </button>

        <!-- Status Display -->
        <div id="status" class="mt-4 text-center text-gray-600 font-medium">Initializing...</div>

        <!-- Output Links Container -->
        <div id="outputLinks" class="mt-4 space-y-2">
            <!-- Download links will appear here -->
        </div>

        <!-- Error Log -->
        <div class="mt-6" id="errorContainer" hidden>
             <h3 class="text-lg font-semibold text-red-700 mb-2">Error Log:</h3>
             <pre id="errorLog" class="bg-red-50 p-3 border border-red-300 rounded-md text-red-800 text-sm"></pre>
        </div>

    </div>

    <!-- JavaScript -->
    <script type="module">
        // --- DOM Elements ---
        const videoInput = document.getElementById('videoInput');
        const extractButton = document.getElementById('extractButton');
        const statusElement = document.getElementById('status');
        const outputLinksContainer = document.getElementById('outputLinks');
        const errorContainer = document.getElementById('errorContainer');
        const errorLogElement = document.getElementById('errorLog');

        // --- FFmpeg Setup ---
        // IMPORTANT: Adjust these paths if your assets are located elsewhere
        const ffmpegPath = './ffmpeg-assets/index.js'; // Expects ESM build's index.js
        const corePath = './ffmpeg-core.js';       // Relative path to ffmpeg-core.js (ESM)
        const workerPath = './worker.js';         // Relative path to worker.js (ESM)

        let ffmpeg = null; // To hold the FFmpeg instance

        // --- Helper Function for Logging Errors ---
        function logError(message, error = null) {
            console.error(message, error);
            errorContainer.hidden = false;
            let errorText = `[Error] ${message}`;
            if (error) {
                errorText += `\nDetails: ${error.stack || error.toString()}`;
            }
            errorLogElement.textContent += errorText + '\n---------------\n';
            statusElement.textContent = `Error occurred. Check log below.`;
            extractButton.disabled = false; // Re-enable button on error
            extractButton.textContent = 'Extract Frames';
        }

        // --- Initialize FFmpeg ---
        async function initializeFFmpeg() {
            try {
                statusElement.textContent = "Loading FFmpeg library...";
                console.log("Importing FFmpeg library from:", ffmpegPath);
                const { FFmpeg } = await import(ffmpegPath);
                console.log("FFmpeg library imported.");

                ffmpeg = new FFmpeg();

                // Optional: Listen for logs from FFmpeg
                ffmpeg.on('log', ({ type, message }) => {
                    console.log(`[ffmpeg ${type}] ${message}`);
                });

                statusElement.textContent = "Loading FFmpeg core (this may take a moment)...";
                console.log("Loading core/worker with paths:", { coreURL: corePath, classWorkerURL: workerPath });
                await ffmpeg.load({
                    coreURL: corePath,
                    classWorkerURL: workerPath
                });
                console.log("FFmpeg core loaded successfully.");

                statusElement.textContent = "FFmpeg ready. Select a video file.";
                extractButton.textContent = 'Extract Frames';
                extractButton.disabled = false; // Enable button only after loading

            } catch (err) {
                 logError("Failed to initialize FFmpeg. Check console and asset paths.", err);
                 statusElement.textContent = "Error loading FFmpeg. Check console & paths.";
                 extractButton.textContent = 'FFmpeg Load Failed';
                 extractButton.disabled = true;
            }
        }

        // --- Frame Extraction Logic ---
        async function extractFrames() {
            if (!ffmpeg || !ffmpeg.loaded) {
                logError("FFmpeg is not loaded yet.");
                return;
            }
            if (videoInput.files.length === 0) {
                statusElement.textContent = "Please select a video file first.";
                return;
            }

            const file = videoInput.files[0];
            const inputFilename = "input." + file.name.split('.').pop(); // e.g., input.mp4
            const outputFilename1 = 'frame_01s.jpg'; // Frame at 1 second
            const outputFilename2 = 'frame_05s.jpg'; // Frame at 5 seconds

            // --- UI Updates ---
            extractButton.disabled = true;
            extractButton.textContent = 'Processing...';
            statusElement.textContent = 'Reading video file...';
            outputLinksContainer.innerHTML = ''; // Clear previous links
            errorLogElement.textContent = '';   // Clear previous errors
            errorContainer.hidden = true;      // Hide error container

            try {
                // 1. Read file into Uint8Array
                const data = new Uint8Array(await file.arrayBuffer());
                statusElement.textContent = `Writing ${inputFilename} to virtual filesystem...`;
                console.log(`Writing ${file.name} as ${inputFilename}`);
                await ffmpeg.writeFile(inputFilename, data);

                // 2. Extract Frame 1 (at 1 second)
                statusElement.textContent = 'Extracting frame at 1 second...';
                console.log(`Executing: -i ${inputFilename} -ss 00:00:01 -vframes 1 ${outputFilename1}`);
                await ffmpeg.exec(['-i', inputFilename, '-ss', '00:00:01', '-vframes', '1', outputFilename1]);
                console.log(`${outputFilename1} extracted.`);

                // 3. Extract Frame 2 (at 5 seconds) - Make sure video is long enough!
                statusElement.textContent = 'Extracting frame at 5 seconds...';
                console.log(`Executing: -i ${inputFilename} -ss 00:00:05 -vframes 1 ${outputFilename2}`);
                await ffmpeg.exec(['-i', inputFilename, '-ss', '00:00:05', '-vframes', '1', outputFilename2]);
                console.log(`${outputFilename2} extracted.`);

                // 4. Read extracted frames
                statusElement.textContent = 'Reading extracted frames...';
                const frameData1 = await ffmpeg.readFile(outputFilename1);
                const frameData2 = await ffmpeg.readFile(outputFilename2);

                // 5. Create download links
                createDownloadLink(frameData1, outputFilename1);
                createDownloadLink(frameData2, outputFilename2);

                statusElement.textContent = 'Extraction complete! Click links below to download frames.';
                console.log("Processing finished successfully.");

                // Optional: Clean up virtual files
                 await ffmpeg.deleteFile(inputFilename);
                 await ffmpeg.deleteFile(outputFilename1);
                 await ffmpeg.deleteFile(outputFilename2);


            } catch (err) {
                logError(`Failed during frame extraction for ${file.name}`, err);
                statusElement.textContent = 'Error during extraction. See log.';
            } finally {
                // Re-enable button regardless of success or failure
                extractButton.disabled = false;
                extractButton.textContent = 'Extract Frames';
            }
        }

        // --- Helper to Create Download Links ---
        function createDownloadLink(data, filename) {
            const blob = new Blob([data.buffer], { type: 'image/jpeg' }); // Assuming JPG output
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.textContent = `Download ${filename}`;
            a.className = 'block w-full text-center bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded cursor-pointer';
            outputLinksContainer.appendChild(a);

             // Optional: Revoke object URL after a delay to allow download start
            // setTimeout(() => URL.revokeObjectURL(url), 60000); // Revoke after 1 minute
        }

        // --- Event Listeners ---
        extractButton.addEventListener('click', extractFrames);

        // --- Start Initialization ---
        initializeFFmpeg();

    </script>
</body>
</html>