<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>ffmpeg.wasm - Extract Frames</title>
    <!-- Include Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Optional: Add custom base styles or component styles if needed */
        /* For example, ensure pre tag wraps correctly */
        pre {
             white-space: pre-wrap; /* Ensures long error messages wrap */
             word-wrap: break-word; /* Breaks long words */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-6 max-w-2xl bg-white shadow-md rounded-lg mt-10">
        <h1 class="text-2xl font-bold mb-4 text-center text-blue-700">Extract 2 Frames from Video</h1>

        <!-- User Input -->
        <div class="mb-4">
            <label for="videoInput" class="block text-sm font-medium text-gray-700 mb-1">Select Video File:</label>
            <input type="file" id="videoInput" accept="video/*"
                   class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer focus:outline-none p-2" />
        </div>

        <!-- Action Button -->
        <button id="extractButton" disabled
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50 disabled:cursor-not-allowed">
            Load FFmpeg & Select File First
        </button>

        <!-- Status Display -->
        <div id="status" class="mt-4 text-center text-gray-600 font-medium">Initializing...</div>

        <!-- Output Links Container -->
        <div id="outputLinks" class="mt-4 space-y-2">
            <!-- Download links will appear here -->
        </div>

        <!-- Error Log -->
        <div class="mt-6" id="errorContainer" hidden>
             <h3 class="text-lg font-semibold text-red-700 mb-2">Error Log:</h3>
             <pre id="errorLog" class="bg-red-50 p-3 border border-red-300 rounded-md text-red-800 text-sm"></pre>
        </div>

    </div>

    <!-- JavaScript -->
    <script type="module">
        // --- DOM Elements ---
        const videoInput = document.getElementById('videoInput');
        const extractButton = document.getElementById('extractButton');
        const statusElement = document.getElementById('status');
        const outputLinksContainer = document.getElementById('outputLinks');
        const errorContainer = document.getElementById('errorContainer');
        const errorLogElement = document.getElementById('errorLog');

        // --- FFmpeg Setup ---
        // IMPORTANT: Adjust these paths if your assets are located elsewhere
        const ffmpegPath = './ffmpeg-assets/index.js'; // Expects ESM build's index.js
        const corePath = './ffmpeg-core.js';       // Relative path to ffmpeg-core.js (ESM)
        const workerPath = './worker.js';         // Relative path to worker.js (ESM)

        let ffmpeg = null; // To hold the FFmpeg instance

        // --- Helper Functions ---
        function updateStatus(message) {
            statusElement.textContent = message;
            console.log(message);
        }

        function logError(message, error = null) {
            console.error(message, error);
            errorContainer.hidden = false;
            let errorText = `[Error] ${message}`;
            if (error) {
                errorText += `\nDetails: ${error.stack || error.toString()}`;
            }
            errorLogElement.textContent += errorText + '\n---------------\n';
            updateStatus(`Error occurred. Check log below.`);
            enableExtractButton();
        }

        function enableExtractButton(enabled = true) {
            extractButton.disabled = !enabled;
            extractButton.textContent = enabled ? 'Extract Frames' : 'Processing...';
        }

        function resetUI() {
            outputLinksContainer.innerHTML = '';
            errorLogElement.textContent = '';
            errorContainer.hidden = true;
        }

        function createDownloadLink(data, filename) {
            const blob = new Blob([data.buffer], { type: 'image/jpeg' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.textContent = `Download ${filename}`;
            a.className = 'block w-full text-center bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded cursor-pointer';
            outputLinksContainer.appendChild(a);
        }

        // --- FFmpeg Operations ---
        async function initializeFFmpeg() {
            try {
                updateStatus("Loading FFmpeg library...");
                console.log("Importing FFmpeg library from:", ffmpegPath);
                const { FFmpeg } = await import(ffmpegPath);
                console.log("FFmpeg library imported.");

                ffmpeg = new FFmpeg();

                // Optional: Listen for logs from FFmpeg
                ffmpeg.on('log', ({ type, message }) => {
                    console.log(`[ffmpeg ${type}] ${message}`);
                });

                updateStatus("Loading FFmpeg core (this may take a moment)...");
                console.log("Loading core/worker with paths:", { coreURL: corePath, classWorkerURL: workerPath });
                await ffmpeg.load({
                    coreURL: corePath,
                    classWorkerURL: workerPath
                });
                console.log("FFmpeg core loaded successfully.");

                updateStatus("FFmpeg ready. Select a video file.");
                enableExtractButton();

            } catch (err) {
                 logError("Failed to initialize FFmpeg. Check console and asset paths.", err);
                 updateStatus("Error loading FFmpeg. Check console & paths.");
                 extractButton.textContent = 'FFmpeg Load Failed';
                 extractButton.disabled = true;
            }
        }

        async function extractFrame(inputFilename, timestamp, outputFilename) {
            updateStatus(`Extracting frame at ${timestamp} seconds...`);
            const formattedTime = `00:00:${String(timestamp).padStart(2, '0')}`;
            await ffmpeg.exec(['-i', inputFilename, '-ss', formattedTime, '-vframes', '1', outputFilename]);
            console.log(`${outputFilename} extracted.`);
        }

        async function processFrames(file) {
            const inputFilename = "input." + file.name.split('.').pop();
            const frames = [
                { timestamp: 1, filename: 'frame_01s.jpg' },
                { timestamp: 5, filename: 'frame_05s.jpg' }
            ];
            
            try {
                // Load video file
                const data = new Uint8Array(await file.arrayBuffer());
                updateStatus(`Writing ${inputFilename} to virtual filesystem...`);
                await ffmpeg.writeFile(inputFilename, data);
                
                // Extract frames
                for (const frame of frames) {
                    await extractFrame(inputFilename, frame.timestamp, frame.filename);
                }
                
                // Read and create download links
                updateStatus('Reading extracted frames...');
                for (const frame of frames) {
                    const frameData = await ffmpeg.readFile(frame.filename);
                    createDownloadLink(frameData, frame.filename);
                    await ffmpeg.deleteFile(frame.filename);
                }
                
                // Clean up
                await ffmpeg.deleteFile(inputFilename);
                updateStatus('Extraction complete! Click links below to download frames.');
                
            } catch (err) {
                throw err;
            }
        }

        // --- Main Extraction Function ---
        async function extractFrames() {
            if (!ffmpeg || !ffmpeg.loaded) {
                logError("FFmpeg is not loaded yet.");
                return;
            }
            if (videoInput.files.length === 0) {
                updateStatus("Please select a video file first.");
                return;
            }

            enableExtractButton(false);
            updateStatus('Reading video file...');
            resetUI();

            try {
                await processFrames(videoInput.files[0]);
            } catch (err) {
                logError(`Failed during frame extraction for ${videoInput.files[0].name}`, err);
                updateStatus('Error during extraction. See log.');
            } finally {
                enableExtractButton();
            }
        }

        // --- Event Listeners ---
        extractButton.addEventListener('click', extractFrames);

        // --- Start Initialization ---
        initializeFFmpeg();

    </script>
</body>
</html>