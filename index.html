<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ffmpeg.wasm Demo â€“ WebM to MP4 (ESM)</title>
  <!-- Scripts will be loaded via ES Module import -->
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 0 20px;
    }
    #status {
      margin: 20px 0;
      font-weight: bold;
    }
    #progressBar {
      width: 100%;
      max-width: 400px;
      margin: 10px 0;
    }
    #outputVideo {
      max-width: 100%;
      margin: 20px 0;
    }
    #errorLog {
      color: red;
      white-space: pre-wrap;
      background: #f8f8f8;
      padding: 10px;
      border-radius: 4px;
      display: block; /* Make sure errors are visible by default */
      border: 1px solid #ddd;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>WebM to MP4 Transcoder (ESM Load)</h1>
  <div id="status">Initializing...</div>
  <progress id="progressBar" value="0" max="100"></progress>
  <video id="outputVideo" controls></video>
  <pre id="errorLog">Error Log:
---------------
</pre>

  <script type="module">
    const errorLogElement = document.getElementById('errorLog');
    const statusElement = document.getElementById('status');

    // Global error handler
    window.onerror = function(message, source, lineno, colno, error) {
      console.error("[Global Error Handler]", message, source, lineno, colno, error);
      errorLogElement.textContent += `\n[Global Error] ${message}\n  Source: ${source}\n  Line: ${lineno}, Col: ${colno}\n  Error Obj: ${error ? error.stack || error : 'N/A'}\n---------------\n`;
      if (!statusElement.textContent.startsWith("Error")) {
          statusElement.textContent = "A critical error occurred. Check error log.";
      }
      return false;
    };

    console.log('Module script executing...');
    statusElement.textContent = "Importing FFmpeg library (ESM)...";

    // --- Define ESM URLs (using version 0.12.10) --- 
    const ffmpegVersion = "0.12.10";
    const coreVersion = "0.12.10"; // Use matching core version
    const ffmpegUrl = `https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@${ffmpegVersion}/+esm`;
    const coreJsUrl = `https://cdn.jsdelivr.net/npm/@ffmpeg/core@${coreVersion}/dist/esm/ffmpeg-core.js`; 
    const coreWasmUrl = `https://cdn.jsdelivr.net/npm/@ffmpeg/core@${coreVersion}/dist/esm/ffmpeg-core.wasm`;
    const workerUrl = `https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@${ffmpegVersion}/dist/esm/worker.js`; 

    // Helper function to fetch a URL and create a Blob URL
    async function toBlobURL(url, mimeType) {
        statusElement.textContent = `Fetching ${url.substring(url.lastIndexOf('/') + 1)}...`;
        console.log(`Fetching ${url}...`);
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Failed to fetch ${url}: ${response.status} ${response.statusText}`);
        }
        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);
        console.log(`Created Blob URL for ${url}: ${blobUrl}`);
        return blobUrl;
    }
    
    try {
      // --- Import necessary items from the ESM build --- 
      const { FFmpeg, fetchFile } = await import(ffmpegUrl);
      console.log('FFmpeg ESM module imported successfully.');
      statusElement.textContent = "FFmpeg library imported. Preparing assets...";

      // --- Create Blob URLs for core and worker scripts --- 
      statusElement.textContent = "Fetching required assets...";
      const coreBlobUrl = await toBlobURL(coreJsUrl, 'text/javascript');
      const wasmBlobUrl = await toBlobURL(coreWasmUrl, 'application/wasm');
      const workerBlobUrl = await toBlobURL(workerUrl, 'text/javascript');
      statusElement.textContent = "Assets fetched and prepared.";

      // --- Instantiate the FFmpeg class --- 
      const ffmpeg = new FFmpeg(); 
      console.log('FFmpeg instance created.');

      // --- Attach event handlers --- 
      ffmpeg.on('progress', ({ progress, time }) => {
        const percent = Math.round(progress * 100);
        progressBar.value = percent;
        if (!statusElement.textContent.includes("complete") && !statusElement.textContent.includes("Error")) {
             statusElement.textContent = `Processing... ${percent}%`;
        }
      });
      ffmpeg.on('log', ({ type, message }) => {
        console.log(`[ffmpeg ${type}] ${message}`);
      });

      // --- Load the core using Blob URLs and trying workerLoadURL --- 
      statusElement.textContent = "Loading ffmpeg.wasm core (may take time)...";
      console.log(`Loading FFmpeg core via ffmpeg.load() using Blob URLs (v${coreVersion})...`);
      await ffmpeg.load({
          coreURL: coreBlobUrl, 
          wasmURL: wasmBlobUrl,
          // Try using workerLoadURL key based on GH issue
          workerLoadURL: workerBlobUrl 
      }); 
      console.log('FFmpeg core loaded successfully via ffmpeg.load()');
      statusElement.textContent = "FFmpeg core loaded.";

      // --- Start FFmpeg processing --- 
      const progressBar = document.getElementById('progressBar');
      const videoEl = document.getElementById('outputVideo');
      
      statusElement.textContent = "Fetching input video file...";
      console.log('Fetching input video...');
      const videoData = await fetchFile(
        "https://raw.githubusercontent.com/ffmpegwasm/testdata/master/Big_Buck_Bunny_180_10s.webm"
      );
      console.log('Input video fetched successfully');

      await ffmpeg.writeFile('input.webm', videoData);
      console.log('Input video written to virtual filesystem');

      statusElement.textContent = "Transcoding to MP4 (this may take a moment)...";
      console.log('Starting transcoding...');
      await ffmpeg.exec(['-i', 'input.webm', 'output.mp4']);
      console.log('Transcoding completed');

      const outputData = await ffmpeg.readFile('output.mp4');
      console.log('Output file read');

      const blob = new Blob([outputData.buffer], { type: 'video/mp4' });
      const videoURL = URL.createObjectURL(blob);
      // Revoke helper blob URLs now that ffmpeg is loaded
      URL.revokeObjectURL(coreBlobUrl);
      URL.revokeObjectURL(wasmBlobUrl);
      URL.revokeObjectURL(workerBlobUrl);
      console.log('Revoked temporary Blob URLs');

      videoEl.src = videoURL;
      console.log('Video source set');

      statusElement.textContent = "Transcoding complete! Click play to view.";
      progressBar.value = 100;

      console.log('Processing finished.');

    } catch (err) {
      console.error('Error during module import or FFmpeg operation:', err);
      const errorMsg = `An error occurred: ${err.stack || err.toString()}`;
      errorLogElement.textContent += `\n[Error] ${errorMsg}\n---------------\n`;
      if (err.message && err.message.includes("import")) {
          statusElement.textContent = "Error importing FFmpeg library. Check console/network.";
      } else if (statusElement.textContent.includes("Fetching") || statusElement.textContent.includes("Loading")) {
          statusElement.textContent = "Error fetching/loading FFmpeg assets. Check URLs and network.";
      } else {
          statusElement.textContent = "Error during processing. Check error log.";
      }
    }

  </script>
</body>
</html>